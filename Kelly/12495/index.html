<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/../assets/duck.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/../assets/duck.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/../assets/duck.png">
  <link rel="mask-icon" href="/../assets/duck.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ducktech.me","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="本週要介紹雲原生相關部署知識，當開發到一個階段，就需要把程式碼等部署到環境，雲原生要透過Container部署到K8s，K8s要透過YAML檔案進行部署，以下會先介紹K8s相關基本知識與實作。 ¶What’s YAML YAML: 用來描述資料格式的一種語言 基本語法  case sentivity 空白符號縮排 透過縮排表示層級關係 使用#表示註解  基本型別   文字   數值   布林值">
<meta property="og:type" content="article">
<meta property="og:title" content="[雲原生軟體開發]DEPLOYMENT">
<meta property="og:url" content="https://ducktech.me/Kelly/12495/index.html">
<meta property="og:site_name" content="kelly">
<meta property="og:description" content="本週要介紹雲原生相關部署知識，當開發到一個階段，就需要把程式碼等部署到環境，雲原生要透過Container部署到K8s，K8s要透過YAML檔案進行部署，以下會先介紹K8s相關基本知識與實作。 ¶What’s YAML YAML: 用來描述資料格式的一種語言 基本語法  case sentivity 空白符號縮排 透過縮排表示層級關係 使用#表示註解  基本型別   文字   數值   布林值">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/z8AttXR.png">
<meta property="og:image" content="https://i.imgur.com/s495bnm.png">
<meta property="og:image" content="https://i.imgur.com/nFPtPha.png">
<meta property="og:image" content="https://i.imgur.com/kq7Cq0I.png">
<meta property="og:image" content="https://i.imgur.com/iakaDXY.png">
<meta property="og:image" content="https://i.imgur.com/4yiBfaj.png">
<meta property="og:image" content="https://i.imgur.com/afcYZod.png">
<meta property="og:image" content="https://i.imgur.com/IOfAi4d.png">
<meta property="og:image" content="https://i.imgur.com/MUKfBYz.png">
<meta property="og:image" content="https://i.imgur.com/ifjanqn.png">
<meta property="og:image" content="https://i.imgur.com/PBKiF51.png">
<meta property="og:image" content="https://i.imgur.com/j4n0gdZ.png">
<meta property="og:image" content="https://i.imgur.com/tWkYsN7.png">
<meta property="og:image" content="https://i.imgur.com/z9MjIht.png">
<meta property="og:image" content="https://i.imgur.com/P6sk4qr.png">
<meta property="og:image" content="https://i.imgur.com/cO8NoT5.png">
<meta property="og:image" content="https://i.imgur.com/PelwAE8.png">
<meta property="og:image" content="https://i.imgur.com/S6vtzMd.png">
<meta property="og:image" content="https://i.imgur.com/7Uqn8Hz.png">
<meta property="og:image" content="https://i.imgur.com/ZFEm4qH.png">
<meta property="og:image" content="https://i.imgur.com/xIhnRwg.png">
<meta property="og:image" content="https://i.imgur.com/9NbmFtG.png">
<meta property="og:image" content="https://i.imgur.com/PuhHmgE.png">
<meta property="og:image" content="https://i.imgur.com/UMBXyx8.png">
<meta property="og:image" content="https://i.imgur.com/IDZwtop.png">
<meta property="og:image" content="https://i.imgur.com/essQjd0.png">
<meta property="og:image" content="https://i.imgur.com/BcHaLAb.png">
<meta property="og:image" content="https://i.imgur.com/SmIEJDq.png">
<meta property="article:published_time" content="2022-05-18T17:24:02.000Z">
<meta property="article:modified_time" content="2022-05-27T08:11:42.157Z">
<meta property="article:author" content="Kelly">
<meta property="article:tag" content="Note">
<meta property="article:tag" content="Deployment">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/z8AttXR.png">

<link rel="canonical" href="https://ducktech.me/Kelly/12495/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>[雲原生軟體開發]DEPLOYMENT | kelly</title><meta name="robots" content="noindex">
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">kelly</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>文章</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>關於</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/duck-tech" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://ducktech.me/Kelly/12495/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.imgur.com/Y9m0rZb.jpg">
      <meta itemprop="name" content="Kelly">
      <meta itemprop="description" content="A good heart goes a long way.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kelly">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [雲原生軟體開發]DEPLOYMENT
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2022-05-18 17:24:02" itemprop="dateCreated datePublished" datetime="2022-05-18T17:24:02+00:00">2022-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2022-05-27 08:11:42" itemprop="dateModified" datetime="2022-05-27T08:11:42+00:00">2022-05-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Cloud/" itemprop="url" rel="index"><span itemprop="name">Cloud</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Cloud/%E9%9B%B2%E5%8E%9F%E7%94%9F%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/" itemprop="url" rel="index"><span itemprop="name">雲原生軟體開發</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/Kelly/12495/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Kelly/12495/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>本週要介紹雲原生相關部署知識，當開發到一個階段，就需要把程式碼等部署到環境，雲原生要透過Container部署到K8s，K8s要透過YAML檔案進行部署，以下會先介紹K8s相關基本知識與實作。</p>
<h2 id="What’s-YAML"><a class="header-anchor" href="#What’s-YAML">¶</a>What’s YAML</h2>
<p>YAML: 用來描述資料格式的一種語言</p>
<p>基本語法</p>
<ul>
<li>case sentivity</li>
<li>空白符號縮排</li>
<li>透過縮排表示層級關係</li>
<li>使用#表示註解</li>
</ul>
<p>基本型別</p>
<ul>
<li>
<p>文字</p>
</li>
<li>
<p>數值</p>
</li>
<li>
<p>布林值</p>
</li>
<li>
<p>map</p>
<p>map 是由key-value所組成</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 註解內容</span></span><br><span class="line"><span class="string">---</span>  <span class="string">&lt;==</span> <span class="string">區隔不同物件的設定，當今天想在單一檔案寫多組設定檔時，可用---區隔</span></span><br><span class="line"><span class="attr">apiVersion :</span> <span class="string">v1</span> <span class="string">&lt;==</span> <span class="string">利用這個來區別不同物件的設定</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> <span class="string">&lt;==</span> <span class="string">指定類行為Pod</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span> <span class="string">&lt;==</span> <span class="string">指定Pod的名稱為Web</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="string">app:web</span> <span class="string">&lt;==</span> <span class="string">替Pod打上</span> <span class="string">app:web</span> <span class="string">的標記</span></span><br></pre></td></tr></table></figure>
 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;apiVersion&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;kind&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Pod&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;web&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;labels&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;app&quot;</span><span class="punctuation">:</span><span class="string">&quot;web&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>list</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">args:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">parameters</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&quot;custom message&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">args<span class="punctuation">[</span><span class="string">&quot;parameters&quot;</span><span class="punctuation">,</span> <span class="string">&quot;custom message&quot;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<div class="note warning @">
            <ul><li>不好編寫，容易壞掉</li><li>未有檢查格式的工具</li><li>當設定檔越複雜，會越難維護</li></ul>
          </div>
</li>
</ul>
<p><img src="https://i.imgur.com/z8AttXR.png" alt="K8s manifest tutorial"><br>
基本組成元素<br>
Master : 控管所有資源的中控中心，通常會有四個大元素如對外，如API server，我們透過API與k8s溝通以及其他控制resource的部分。</p>
<p>Worker : 可以想像他是一個實體主機或是虛擬VM，有自己的控制器，如proxy負責處理網路的部分，Pod可以放一個或多個Container，這邊要注意的是<strong>K8s最小單位是Pod</strong>。</p>
<ul>
<li>網路怎麼控制</li>
<li>如何部署</li>
</ul>
<h3 id="Pod"><a class="header-anchor" href="#Pod">¶</a>Pod</h3>
<ol>
<li>
<p>K8s最小運行單位</p>
</li>
<li>
<p>可以運行一個或多個Container</p>
</li>
<li>
<p>臨時性的：當Pod關掉，裡面儲存的檔案會消失，不是永存的，這時候會透過一些storage方式，將檔案存在永久性的空間。</p>
</li>
<li>
<p>無replication、self-heal等功能，需透握其他的控制項目來達到，如：Deployment</p>
</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># K8s Pods Doc</span></span><br><span class="line"><span class="attr">apibersion :</span> <span class="string">v1</span>  <span class="comment"># 通知api server要存取的api版本</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> <span class="comment"># 我要去寫一個Pod描述檔</span></span><br><span class="line"><span class="attr">metadata:</span>  <span class="comment"># 描述物件資料，可以被用於像是service，像是可以當作選擇條件</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rss-site</span></span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">app:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span> <span class="comment"># 要執行的東西，如這邊要執行兩個Container</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">front-end</span> <span class="comment">#container 名稱</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span> <span class="comment"># image:名稱</span></span><br><span class="line">      <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="string">containerPort80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rss-reader</span> </span><br><span class="line">      <span class="attr">image:</span> <span class="string">nickchase/rss-php-nginx:v1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="attr">apibersion :</span> <span class="string">extensions/v1betal</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># Pod 本身沒有，當我Pod啟動時，會開啟3個一樣的Pod</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># 描述每個 Pod 想要的樣子</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span> </span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span>  </span><br></pre></td></tr></table></figure>
<h4 id="service"><a class="header-anchor" href="#service">¶</a>service</h4>
<p>因為Pod每次啟動都會取得不同的IP，使用者如果要存取 pod就會變得十分困難，這時候service就可以派上用場。<br>
Service 使用 label 和 selector來決定如何存取(policy) 以及可以存取哪些Pod(logical group)<br>
<img src="https://i.imgur.com/s495bnm.png" alt="service圖示"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span> <span class="comment"># 指定為service物件</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># Service 型態，NodePort, LoadBalancer等可以選擇</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span> <span class="comment"># 指定service 綁定 Label 有app:nginx的Pod</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<div class="note warning@">
            <p>Service 型態有三種</p><ul><li>僅供 cluster 內部存取 ：Cluster IP</li><li>供cluste和外部存取 ： NodePort, LoadBalancer</li><li>對應 cluster外其他資源 ：ExternalName</li></ul>
          </div>
<h4 id="Ingress"><a class="header-anchor" href="#Ingress">¶</a>Ingress</h4>
<p>如果沒有透過Ingress，K8s 外面的人事沒有辦法使用執行起來的服務，透過Ingress可以讓外部的使用者連到cluster的服務。<br>
<img src="https://i.imgur.com/nFPtPha.png" alt="Ingress"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span>   <span class="string">&lt;===</span> <span class="string">指定物件種類為</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">green.myweb.com</span> <span class="string">&lt;===</span> <span class="string">指定</span> <span class="string">host</span> <span class="string">名稱為</span> <span class="string">green.myweb.com</span> </span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">green-service</span>  <span class="string">&lt;===</span> <span class="string">綁定名稱為</span> <span class="string">green-service</span> <span class="string">的</span> <span class="string">Service</span> <span class="string">物件</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span>  </span><br></pre></td></tr></table></figure>
<h2 id="Deploy-to-GKE-實際演練"><a class="header-anchor" href="#Deploy-to-GKE-實際演練">¶</a>Deploy to GKE (實際演練)</h2>
<p>本週練習，請大家 <a target="_blank" rel="noopener" href="https://github.com/chgc/w13-deployment">fork</a> 這版來完成今天的練習</p>
<ol>
<li>瞭解 Dockfile</li>
<li>知道如何透過 GitHub Action 部屬到 GKE</li>
</ol>
<p>專案 clone 下來後，進入專案的資料夾，這是範例程式碼，用什麼 framework 不是重點。重點會是如將 image 建置完成後，透過 GitHub Action 部屬到 GKE 上</p>
<h3 id="Dockerfile"><a class="header-anchor" href="#Dockerfile">¶</a>Dockerfile</h3>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:lts-alpine AS react-nx-base &lt;== Image base </span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app &lt;== 工作資料夾</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm ci &lt;== npm install </span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm run build</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm prune --production</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> nginx:alpine AS react-nx-ui</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/share/nginx/html</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=react-nx-base /app/dist/apps/gke-demo .</span></span><br></pre></td></tr></table></figure>
<ul>
<li>本機建置 docker image</li>
</ul>
<p><code>docker build . -t &lt;image-tag-name&gt;</code></p>
<p><code>&lt;image-tag-name&gt;</code>: 給予一個 tag 名稱, 這邊我取 <code>gke-demo</code></p>
<ul>
<li>查詢 image id</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>
<p>找到剛剛建立的 image，並將 id 記起來<br>
<img src="https://i.imgur.com/kq7Cq0I.png" alt="image Id"></p>
<ul>
<li>將 image 跑起來</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name gke-demo -it --<span class="built_in">rm</span> -p 8081:80 &lt;image-id&gt;</span><br></pre></td></tr></table></figure>
<p><code>&lt;image-id&gt;</code>: 替換成剛剛查詢到的 id, 例如: 以上圖為例，就會替換成 7338 (docker 很聰明，不需要打完全部就能找到我們要的 image)</p>
<p>指令說明</p>
<ul>
<li><code>-name</code>:  Assign name</li>
<li><code>-it</code> : instructs Docker to allocate a pseudo-TTY connected to the container’s stdin</li>
<li><code>--rm</code>: Automatically remove the container when it exits</li>
<li><code>-p</code>: Publish a container’s port(s) to the host, [本機 Port]:[Container 內部 Port]</li>
</ul>
<p>啟動後，在瀏覽器輸入 <code>http://localhost:8081</code> 即可看到以下畫面<br>
<img src="https://i.imgur.com/iakaDXY.png" alt="啟動成功"></p>
<h3 id="Deploy-to-GKE"><a class="header-anchor" href="#Deploy-to-GKE">¶</a>Deploy to GKE</h3>
<h4 id="GCP-上建立一個新專案-如果已經有建立，可忽略此步驟"><a class="header-anchor" href="#GCP-上建立一個新專案-如果已經有建立，可忽略此步驟">¶</a>GCP 上建立一個新專案 (如果已經有建立，可忽略此步驟)</h4>
<ol>
<li>
<p>新增服務帳戶 Service Account<br>
Step 1<br>
<img src="https://i.imgur.com/4yiBfaj.png" alt="GKE"><br>
Step 2<br>
<img src="https://i.imgur.com/afcYZod.png" alt="GKE"><br>
Step 3<br>
<img src="https://i.imgur.com/IOfAi4d.png" alt="GKE"><br>
Step 4<br>
<img src="https://i.imgur.com/MUKfBYz.png" alt="GKE"><br>
Step 5: 新增兩個權限<br>
<img src="https://i.imgur.com/ifjanqn.png" alt="GKE"><br>
Step 6:<br>
<img src="https://i.imgur.com/PBKiF51.png" alt="GKE"><br>
Step 7:<br>
<img src="https://i.imgur.com/j4n0gdZ.png" alt="GKE"><br>
Step 8:<br>
<img src="https://i.imgur.com/tWkYsN7.png" alt="GKE"><br>
Step 9: 會下載一個 json 檔案，等等會用到<br>
<img src="https://i.imgur.com/z9MjIht.png" alt="GKE"></p>
</li>
<li>
<p>如果沒有建立過 GKE Cluster 可以 follow 這個步驟</p>
</li>
</ol>
<p>Step 1<br>
<img src="https://i.imgur.com/P6sk4qr.png" alt="GKE Cluster"><br>
Step 2<br>
<img src="https://i.imgur.com/cO8NoT5.png" alt="GKE Cluster"><br>
Step 3<br>
<img src="https://i.imgur.com/PelwAE8.png" alt="GKE Cluster"><br>
Step 4: 簡單設定 Demo 用<br>
<img src="https://i.imgur.com/S6vtzMd.png" alt="GKE Cluster"><br>
Step 5: 地區選擇 <code>asia-east1</code><br>
<img src="https://i.imgur.com/7Uqn8Hz.png" alt="GKE Cluster"><br>
Step 6: 建立<br>
<img src="https://i.imgur.com/ZFEm4qH.png" alt="GKE Cluster"></p>
<h4 id="建立-GitHub-Action"><a class="header-anchor" href="#建立-GitHub-Action">¶</a>建立 GitHub Action</h4>
<p>1.建立 action workflow</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">GKE</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">PROJECT_ID:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GKE_PROJECT</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">GKE_CLUSTER:</span> <span class="string">autopilot-cluster-1</span>    <span class="comment"># <span class="doctag">TODO:</span> update to cluster name</span></span><br><span class="line">  <span class="attr">GKE_ZONE:</span> <span class="string">asia-east1</span>   <span class="comment"># <span class="doctag">TODO:</span> update to cluster zone</span></span><br><span class="line">  <span class="attr">DEPLOYMENT_NAME:</span> <span class="string">gke-app</span> <span class="comment"># <span class="doctag">TODO:</span> update to deployment name</span></span><br><span class="line">  <span class="attr">IMAGE:</span> <span class="string">gke-demo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">setup-build-publish-deploy:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Setup,</span> <span class="string">Build,</span> <span class="string">Publish,</span> <span class="string">and</span> <span class="string">Deploy</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Setup gcloud CLI</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">&#x27;auth&#x27;</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">&#x27;google-github-actions/auth@v0&#x27;</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">credentials_json:</span> <span class="string">&#x27;$<span class="template-variable">&#123;&#123; secrets.GKE_SA_KEY &#125;&#125;</span>&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">google-github-actions/setup-gcloud@v0</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">project_id:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GKE_PROJECT</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Configure Docker to use the gcloud command-line tool as a credential</span></span><br><span class="line">    <span class="comment"># helper for authentication</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">        gcloud --quiet auth configure-docker</span></span><br><span class="line"><span class="string"></span>    <span class="comment"># Get the GKE credentials so we can deploy to the cluster</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">        gcloud container clusters get-credentials &quot;$GKE_CLUSTER&quot; --zone &quot;$GKE_ZONE&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="comment"># Build the Docker image</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">        docker build \</span></span><br><span class="line"><span class="string">          --tag &quot;gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA&quot; \ </span></span><br><span class="line"><span class="string">          --build-arg GITHUB_SHA=&quot;$GITHUB_SHA&quot; \</span></span><br><span class="line"><span class="string">          --build-arg GITHUB_REF=&quot;$GITHUB_REF&quot; \</span></span><br><span class="line"><span class="string">          .</span></span><br><span class="line"><span class="string"></span>    <span class="comment"># Push the Docker image to Google Container Registry</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Publish</span> </span><br><span class="line">      <span class="attr">run:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">        docker push &quot;gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA&quot;</span></span><br><span class="line"><span class="string"></span>    <span class="comment"># Set up kustomize</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Kustomize</span> <span class="string">&lt;=</span> <span class="string">更彈性的設定K8s</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">        cd ./k8s # 如果 mainfest 是放在某一個資料夾，這邊要替換成該資料夾名稱</span></span><br><span class="line"><span class="string">        curl -sfLo kustomize https://github.com/kubernetes-sigs/kustomize/releases/download/v3.1.0/kustomize_3.1.0_linux_amd64</span></span><br><span class="line"><span class="string">        chmod u+x ./kustomize</span></span><br><span class="line"><span class="string"></span>    <span class="comment"># Deploy the Docker image to the GKE cluster</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">        cd ./k8s # 如果 mainfest 是放在某一個資料夾，這邊要替換成該資料夾名稱</span></span><br><span class="line"><span class="string">        ./kustomize edit set image gcr.io/PROJECT_ID/IMAGE:TAG=gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA</span></span><br><span class="line"><span class="string">        ./kustomize build . | kubectl apply -f -</span></span><br><span class="line"><span class="string">        kubectl rollout status deployment/$DEPLOYMENT_NAME</span></span><br><span class="line"><span class="string">        kubectl get services -o wide</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<div class="note info@">
            <p>yml 自身也使用了幾個 env 參數</p><ul><li>PROJECT_ID: $  # 自動會帶入來自 secret 設定</li><li>GKE_CLUSTER: cluster-1 # 輸入你所建立的叢集名稱</li><li>GKE_ZONE: asia-east1 # 輸入你的叢集主要地區 zone</li><li>DEPLOYMENT_NAME: gke-app # 部署名稱, 此名在其他 yml 需要一致</li><li>IMAGE: my-image # docker 映像名稱</li></ul>
          </div>
<p>2.設定 secret，新增 repository secret</p>
<p><img src="https://i.imgur.com/xIhnRwg.png" alt="GITHUB設定secret"></p>
<ul>
<li>GKE_PROJECT：專案 id</li>
<li>GKE_SA_KEY：專案金鑰，建立 secret 時，務必整個 JSON 內容貼上</li>
</ul>
<p>3.建立 mainfest</p>
<p>3-1 新增 k8s 資料夾，以下三個檔案會放在這邊統一管理<br>
3-2 kustomization.yml</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">deployment.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">service.yml</span></span><br></pre></td></tr></table></figure>
<p>4.deployment.yml</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gke-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">selector:</span></span><br><span class="line">  <span class="attr">matchLabels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">gke-app</span></span><br><span class="line"><span class="attr">strategy:</span></span><br><span class="line">  <span class="attr">rollingUpdate:</span></span><br><span class="line">    <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">minReadySeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">template:</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">gke-app</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gke-app</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">gcr.io/PROJECT_ID/IMAGE:TAG</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">100m</span></span><br></pre></td></tr></table></figure>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gke-app-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">gke-app</span></span><br></pre></td></tr></table></figure>
<p>4.Commit &amp; push 觸發 GitHub Action<br>
<img src="https://i.imgur.com/9NbmFtG.png" alt="GitHub Action"></p>
<p>5.回到 GCP 控制台 - Kubernetes Engine 的頁面，在 <code>工作負載</code> 和 <code>Service 與 Ingress</code> 的功能中，應可看到正在運行的網站<br>
<img src="https://i.imgur.com/PuhHmgE.png" alt="GCP success"></p>
<p>問題 ： Rollback比較不好做。最大原因是Deployment被綁在CI部分所以變成build完Code就push到GKE環境。</p>
<h2 id="Deployment-strategy"><a class="header-anchor" href="#Deployment-strategy">¶</a>Deployment strategy</h2>
<p>部署上線後碰到問題絕對是先降版本，因為你通常要花很多時間解決問題，重點是我們不希望我們停頓太久。</p>
<ul>
<li>Recrete</li>
<li>Ramped</li>
<li>Blue/Green</li>
<li>Canary</li>
<li>A/B testing</li>
</ul>
<h3 id="Recrete"><a class="header-anchor" href="#Recrete">¶</a>Recrete</h3>
<p>把舊版砍掉(先停下來)再把新版部署上去。</p>
<p>K8s :</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recrete</span></span><br></pre></td></tr></table></figure>
<p>優點：應用程序狀態完全更新</p>
<p>缺點：當我舊版停下來使用者就不能用，到我新版上線Ready之前，上線下線都要花一點時間。 e.g. 線上遊戲停機時間</p>
<h3 id="Ramped"><a class="header-anchor" href="#Ramped">¶</a>Ramped</h3>
<p>Recrete可以像是先拆後建，Remaped是Rolling upgrate一台台一台拆，一台台建如replicas 現在是 3 台，那我現在拆掉一台至少有兩台做服務，第三台先上新版，等成功後再將其他下來上去。</p>
<p><img src="https://i.imgur.com/UMBXyx8.png" alt="Remaped"></p>
<p>優點 ：</p>
<ul>
<li>版本跨實例緩慢發布</li>
<li>方便可以處理數據重新平衡的有狀態應用程序</li>
<li>不會停機</li>
</ul>
<p>缺點 ：</p>
<ul>
<li>rollout/rollback可能需要時間: 一台台要先下後上，如果有5、60台，Deploy會非常久。過去解決方案：會先縮小到只剩下5台，做Rolling upgrate，等結束後就rescale到50台，但這樣做也不是個好作法因為你無法保證原本50台縮到變5台的時候會不會出事情。另一個問題是原本是3台，在rolling upgrate 時在只剩下兩台的時候無法保證不會出事。</li>
<li>支持多個 API 很難</li>
<li>無法控制流量</li>
</ul>
<h3 id="Blue-Green"><a class="header-anchor" href="#Blue-Green">¶</a>Blue/Green</h3>
<p>相較於Remaped是一台台換版，Blue/Green會分成兩群，可以看到先把綠色兩台下來，只剩兩台藍色服務，在上去的時候還是用藍色做服務，等v2 Ready 後再指向綠色服務，接下來換Blue做upgrate。<br>
<img src="https://i.imgur.com/IDZwtop.png" alt="Blue/Green"></p>
<p>優點 ：</p>
<ul>
<li>即時 rollout/rollback :避免同時有兩個版本在線上服務</li>
<li>避免版本控制問題，一次性更改整個集群狀態</li>
</ul>
<p>缺點 ：</p>
<ul>
<li>
<p>需要雙倍的資源 ： 相較Ramped一次需要下比較多台，挑使用者較少的時候來進行部署</p>
</li>
<li>
<p>在發佈到生產環境之前，應該對整個平台進行適當的測試</p>
</li>
<li>
<p>處理有狀態的應用程序可能很困難</p>
<div class="note info @">
            <p>不一定是分成兩群</p>
          </div>
</li>
</ul>
<h3 id="Canary"><a class="header-anchor" href="#Canary">¶</a>Canary</h3>
<p>部屬的時候我們希望一套部署成功再部署另外一台，上述的策略只能避免真的部屬失敗(Deploy Pod不上去失敗)，但這件事情不會很常出現，因為如果前面有測試環境一定是部署過了。常發生的事情是你的程式有你沒有test到的東西，部署上去部署成功但實際上你程式function是有問題的(使用者回饋說登入不能用)，這時候你可能就會牽涉到Rollback。<br>
<img src="https://i.imgur.com/essQjd0.png" alt="Canary"><br>
e.g. 10個Pod，先把1個換版把10%的使用者導流到這個Pod，如觀察個五個小時沒人抱怨，再把30%的Pod換版開放30％看看有沒有問題，沒問題再開放70%到100%。假如在10%發生問題，那我Rollback就只要10%的人。<br>
通常用在測試資源不太夠時，適合用Canary的方式進行。</p>
<p>優點 ：</p>
<ul>
<li>為部分用戶發布的版本</li>
<li>便於錯誤率和性能監控</li>
<li>快速Rollback</li>
</ul>
<p>缺點 ：</p>
<ul>
<li>slow rollout</li>
<li>微調的流量分配可能很昂貴（99% A/1%B = 99 個 pod A，1 個 pod B）</li>
</ul>
<h3 id="A-B-testing"><a class="header-anchor" href="#A-B-testing">¶</a>A/B testing</h3>
<p>不是為了解決部署發生的問題，通常用在測試user喜好，如我今天有個功能有個設計師3個步驟，另一個設計用5個步驟，但我不知道哪個對使用者來說是便利的，然後會去將使用者去作分流如30%70%。因為牽涉到如何分流使用者和使用者點擊資料等，因此有別於前面幾種，現在CICD工具較不能做到。<br>
<img src="https://i.imgur.com/BcHaLAb.png" alt="A/B testing"><br>
A/B testing 比較像要解決設計上的問題，不好做的原因不在於技術面而是你設計要找的問題點是什麼，因此要考量很多東西。</p>
<p>優點</p>
<ul>
<li>需要智能負載均衡器</li>
<li>多個版本並行運行</li>
<li>完全控制流量分配</li>
</ul>
<p>缺點</p>
<ul>
<li>很難解決給定session的錯誤，分佈式跟踪成為強制性的</li>
<li>不簡單，您需要設置額外的工具</li>
</ul>
<h2 id="Deploy-考慮事項"><a class="header-anchor" href="#Deploy-考慮事項">¶</a>Deploy 考慮事項</h2>
<ul>
<li>Release management:版本管理，在錯誤時要查改過哪些code，才能較有效率。</li>
<li>Sanity check: 上線部署完，檢查部署有沒有問題</li>
<li>Rollback plan</li>
<li>Release plan</li>
<li>Testing<br>
…etc.</li>
</ul>
<h2 id="key"><a class="header-anchor" href="#key">¶</a>key</h2>
<p>project_id: w13-gke-doc</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;service_account&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;project_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;w13-gke-doc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;private_key_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8b531aa028eeda6e61a4020f1e7e763f7ddb3788&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;private_key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCy06i/UaZlW9eh\n6HLgfkeXpt0sDQ0kZGrpg5b5MABGDIKtMarU/E68tSr7MgjEW63XEWMf/G6bJ2A2\nKivXXX4NyDi9u0mRq6+iTpN4+o8MPFSd7rxH0ZcdWLQmzg5Ig0HhQyl7qNqR++w1\nB3+W8rUh53FOilhD2CxPLAabT4pG2zAnNpaWNwSfZHPuDrLQYFQ0Sj/SDEHBumRn\ned/GHgMVXzooLf2GZf63vq8tLryZYLXICEtuDslOmyPSfDOXthO8d/STQ4v3neh/\nAzeVIYkMkcO+xWIMo02Sq+B5GV8kkrj9EUSJOlcnZ65bCdwN/X+c/ByFcNTuapjZ\nSNHfDZv1AgMBAAECggEAVAm49zP5VQ/Mrbdt6QcfQOr3bICzqOMSBSxEclV3A3RU\nouzA4feyTud6y/KvAQwujXAL29fG6N4fzkSSNtMmbnamB6/wumbrEoUHs+ZX/EGL\n6G5th/i8odtySfwy5Svd9W0ZHRZ0pP81eZRNBxSHP+girOzB3xxDcm93qVw/WN1W\nZ0gS6nqRnxoYX6EY9TWMN/a09jtRFgHflRUeY3Y23aGojdeXmw6i1hHSkjcQNT2a\nQgVFsbxFle/la11JHu8wdqZaaZYbQiuTQgrtDtEKGAvAcZsupW/9SO7tGd3RHeAx\nvqrA00Ow3C97+SDsbadqr7O6nVrybYM9xljBaqH4HwKBgQDkI0MFtN0ELrMKOalP\nx3VmW6A+lOIv9Vs9MT4s68/916LFzAJARNApfjw/iQODIOP7nDaInOT7pLNMs5F2\ng0TGYMDQy+i8yPQ9MWDwB8BsPOx/RKXhHkfODiLmxw4WNAmNxcyuTvyVOd+idf4K\nqJEMTNayYX9qiBZbdfzgr8CrHwKBgQDIqrAkCHGHPGqdZ24ya0QuSBaba6KK2Dqu\n4MdwCQr1vpo8e2POBkwZ85QcT+7XiPi/cbULiyvtuMFdZXSwvAyZDb29Mg6RY0vc\nBgtilMfL9nwwcBGLqCcAUYJwCEZARLsHJH69ANZ5fj8LT9pvciJVNKeUULURRg1C\nrHN9Jy0qawKBgQC1VqYGmi34Dhq4bP788CGMXBZyyCtGTbPZXxP55vMr5cR3juLX\nLRt9b9757bHCAFnXfOMIEhYdRFxVAoMEffEj8nIxRXPY467oGSDhinfUUVT3EJz9\n5PDUg/4QDHdRBMn3TBuXDifNgfQWEc39sOGisk0R+1epWUTULGP2QR1XpwKBgFiS\nNoMBExMtEKX/ZD1u6T5AZXIedTUxsd1Eq+MAqszDX5K4p9nlH6wIvmQsx/Bsrdba\nmp3IxQ/9j6PoxzPHHQxla01aDeIQYQhxxo6xuuqFFlXO8X+iLezPDXLjxBZT//Vs\nH2DPQNuJZMxaZ8DvMMZJInqtkO5Z7Dp0odko9J+XAoGBANzoU8AnO3fVSr6H6Lvq\n39FdIFhKR5Ab0RLb7p9cf7gmkZRs3N/cCXIJE63RTn8B05md4Hc6eoKnCqQohfE5\nboqESBM8mjBRSN9h5sAaxABSRsPbv7hzo+yFuRVtKEwUhZ0R85Qf1RC8hH2+Bt7k\nMQU9K68PAh9SkKnct9SwtBNP\n-----END PRIVATE KEY-----\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;client_email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;github-action-234@w13-gke-doc.iam.gserviceaccount.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;client_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;115195814638054863882&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auth_uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://accounts.google.com/o/oauth2/auth&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;token_uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://oauth2.googleapis.com/token&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auth_provider_x509_cert_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://www.googleapis.com/oauth2/v1/certs&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;client_x509_cert_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://www.googleapis.com/robot/v1/metadata/x509/github-action-234%40w13-gke-doc.iam.gserviceaccount.com&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<div class="note info@">
            <p>延伸學習 ：Pod Man、GitHub Copilot<br><img src="https://i.imgur.com/SmIEJDq.png" alt="上課留言"><br>GitOps</p>
          </div>
<!-- flag of hidden posts -->
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Note/" rel="tag"># Note</a>
              <a href="/tags/Deployment/" rel="tag"># Deployment</a>
          </div>

        


        
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#What%E2%80%99s-YAML"><span class="nav-number">1.</span> <span class="nav-text">What’s YAML</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod"><span class="nav-number">1.1.</span> <span class="nav-text">Pod</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#service"><span class="nav-number">1.1.1.</span> <span class="nav-text">service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ingress"><span class="nav-number">1.1.2.</span> <span class="nav-text">Ingress</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deploy-to-GKE-%E5%AF%A6%E9%9A%9B%E6%BC%94%E7%B7%B4"><span class="nav-number">2.</span> <span class="nav-text">Deploy to GKE (實際演練)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile"><span class="nav-number">2.1.</span> <span class="nav-text">Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deploy-to-GKE"><span class="nav-number">2.2.</span> <span class="nav-text">Deploy to GKE</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GCP-%E4%B8%8A%E5%BB%BA%E7%AB%8B%E4%B8%80%E5%80%8B%E6%96%B0%E5%B0%88%E6%A1%88-%E5%A6%82%E6%9E%9C%E5%B7%B2%E7%B6%93%E6%9C%89%E5%BB%BA%E7%AB%8B%EF%BC%8C%E5%8F%AF%E5%BF%BD%E7%95%A5%E6%AD%A4%E6%AD%A5%E9%A9%9F"><span class="nav-number">2.2.1.</span> <span class="nav-text">GCP 上建立一個新專案 (如果已經有建立，可忽略此步驟)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-GitHub-Action"><span class="nav-number">2.2.2.</span> <span class="nav-text">建立 GitHub Action</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deployment-strategy"><span class="nav-number">3.</span> <span class="nav-text">Deployment strategy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Recrete"><span class="nav-number">3.1.</span> <span class="nav-text">Recrete</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ramped"><span class="nav-number">3.2.</span> <span class="nav-text">Ramped</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Blue-Green"><span class="nav-number">3.3.</span> <span class="nav-text">Blue&#x2F;Green</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Canary"><span class="nav-number">3.4.</span> <span class="nav-text">Canary</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#A-B-testing"><span class="nav-number">3.5.</span> <span class="nav-text">A&#x2F;B testing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deploy-%E8%80%83%E6%85%AE%E4%BA%8B%E9%A0%85"><span class="nav-number">4.</span> <span class="nav-text">Deploy 考慮事項</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#key"><span class="nav-number">5.</span> <span class="nav-text">key</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Kelly"
      src="https://i.imgur.com/Y9m0rZb.jpg">
  <p class="site-author-name" itemprop="name">Kelly</p>
  <div class="site-description" itemprop="description">A good heart goes a long way.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kelly</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://https-duck-tech-github-io.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://ducktech.me/Kelly/12495/";
    this.page.identifier = "Kelly/12495/";
    this.page.title = "[雲原生軟體開發]DEPLOYMENT";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://https-duck-tech-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
